// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  leader
  member
  viewer
}

enum Plan {
  trial
  basic
  pro
}

enum PersonStatus {
  active
  inactive
  visitor
}

enum ServiceItemType {
  song
  element
  note
}

enum AssignmentStatus {
  pending
  accepted
  declined
}

enum ServiceStatus {
  draft
  published
  archived
}

enum GroupMemberRole {
  leader
  co_leader
  member
  guest
}

enum GroupStatus {
  active
  inactive
  archived
}

enum GroupVisibility {
  public
  private
  hidden
}

enum GroupCategory {
  small_group
  ministry_team
  class
  committee
  prayer_group
  bible_study
  youth_group
  kids_group
  mens_group
  womens_group
  support_group
  service_team
  worship_team
  other
}

enum MemberStatus {
  active
  invited
  requested
  declined
}

enum NotificationType {
  assignment_created
  assignment_reminder
  service_updated
  conflict_detected
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum ContactMethodType {
  mobile
  home
  work
  other
}

enum AddressType {
  home
  work
  other
}

enum CustomFieldType {
  text
  number
  date
  dropdown
  checkbox
  file
}

enum HouseholdRelation {
  head
  spouse
  child
  parent
  other
}

enum ListType {
  static
  smart
}

enum NoteCategory {
  general
  pastoral_care
  follow_up
  other
}

enum FormFieldType {
  text
  textarea
  number
  email
  phone
  date
  dropdown
  checkbox
  radio
  file
}

enum WorkflowStatus {
  active
  paused
  completed
}

enum WorkflowStepType {
  send_email
  send_sms
  assign_tag
  create_task
  notify_admin
  wait
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  subdomain   String   @unique
  plan        Plan     @default(trial)
  planLimits  Json     // {people: 100, groups: 10, servicePlans: 10}
  trialEndAt  DateTime?
  logoUrl     String?
  timezone    String   @default("America/New_York")
  campus      String?  // Default campus
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users              User[]
  sessions           Session[]
  invites            Invite[]
  people             Person[]
  groups             Group[]
  servicePlans       ServicePlan[]
  serviceTemplates   ServiceTemplate[]
  songs              Song[]
  files              File[]
  auditLogs          AuditLog[]
  notifications      Notification[]
  households         Household[]
  tagCategories      TagCategory[]
  tags               Tag[]
  customFieldDefs    CustomFieldDefinition[]
  lists              SavedList[]
  forms              Form[]
  workflows          Workflow[]
  emailTemplates     EmailTemplate[]
  smsTemplates       SmsTemplate[]
  attendanceRecords  AttendanceRecord[]
  reports            Report[]

  @@map("organizations")
}

model User {
  id           String    @id @default(cuid())
  orgId        String
  email        String
  passwordHash String
  role         Role      @default(member)
  firstName    String?
  lastName     String?
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sessions     Session[]
  auditLogs    AuditLog[]
  invitesSent  Invite[]     @relation("InvitesSent")

  @@unique([orgId, email])
  @@index([orgId])
  @@map("users")
}

model Invite {
  id         String    @id @default(cuid())
  orgId      String
  email      String
  role       Role      @default(member)
  invitedBy  String
  code       String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  inviter      User         @relation("InvitesSent", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([email])
  @@index([code])
  @@map("invites")
}

model Session {
  id            String   @id @default(cuid())
  orgId         String
  userId        String
  expiresAt     DateTime
  ipFingerprint String?
  createdAt     DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model Person {
  id                   String       @id @default(cuid())
  orgId                String
  firstName            String
  lastName             String
  middleName           String?
  nickname             String?
  prefix               String?      // Mr., Mrs., Dr., etc.
  suffix               String?      // Jr., Sr., III, etc.
  gender               String?
  birthDate            DateTime?
  anniversary          DateTime?
  photoUrl             String?
  status               PersonStatus @default(active)
  householdId          String?
  householdRelation    HouseholdRelation?

  // Contact preferences
  preferredContactMethod String?    // email, phone, sms
  doNotContact         Boolean      @default(false)
  emailOptIn           Boolean      @default(true)
  smsOptIn             Boolean      @default(true)

  // Profile completeness
  profileCompleteness  Int          @default(0) // 0-100

  // Metadata
  source               String?      // How they were added (import, form, manual, etc.)
  lastViewed           DateTime?
  isFavorite           Boolean      @default(false)
  mergedFrom           Json?        // Array of person IDs that were merged into this one

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  organization         Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  household            Household?           @relation(fields: [householdId], references: [id], onDelete: SetNull)
  groupMemberships     GroupMembership[]
  serviceAssignments   ServiceAssignment[]
  availability         PersonAvailability[]
  phoneNumbers         PersonPhone[]
  emailAddresses       PersonEmail[]
  addresses            PersonAddress[]
  emergencyContacts    EmergencyContact[]
  customFieldValues    CustomFieldValue[]
  personTags           PersonTag[]
  notes                PersonNote[]
  attendanceRecords    AttendanceRecord[]
  communications       Communication[]
  formSubmissions      FormSubmission[]
  workflowInstances    WorkflowInstance[]

  @@index([orgId])
  @@index([orgId, status])
  @@index([householdId])
  @@index([birthDate])
  @@index([anniversary])
  @@map("people")
}

model Group {
  id          String          @id @default(cuid())
  orgId       String
  name        String
  description String?         @db.Text
  cadence     String? // Free text: "Weekly on Wednesdays", "Bi-weekly", etc.
  location    String?
  isOpen      Boolean         @default(true)
  status      GroupStatus     @default(active)
  visibility  GroupVisibility @default(public)
  category    GroupCategory   @default(small_group)
  capacity    Int? // Maximum members (null = unlimited)
  photoUrl    String?
  meetingDay  String? // e.g., "Monday", "Wednesday"
  meetingTime String? // e.g., "7:00 PM"
  campus      String?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  organization      Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members           GroupMembership[]
  comments          GroupComment[]
  meetings          GroupMeeting[]
  resources         GroupResource[]
  prayerRequests    GroupPrayerRequest[]
  attendanceRecords GroupAttendance[]

  @@index([orgId])
  @@index([orgId, status])
  @@index([orgId, category])
  @@index([orgId, visibility])
  @@map("groups")
}

model GroupMembership {
  id        String          @id @default(cuid())
  groupId   String
  personId  String
  role      GroupMemberRole @default(member)
  status    MemberStatus    @default(active)
  notes     String?         @db.Text // Group-specific notes about this member
  joinedAt  DateTime        @default(now())
  createdAt DateTime        @default(now())

  group             Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  person            Person            @relation(fields: [personId], references: [id], onDelete: Cascade)
  attendanceRecords GroupAttendance[]

  @@unique([groupId, personId])
  @@index([groupId])
  @@index([personId])
  @@index([groupId, role])
  @@index([groupId, status])
  @@map("group_memberships")
}

model GroupComment {
  id        String   @id @default(cuid())
  groupId   String
  userId    String // Not FK to avoid cascade issues if user deleted
  content   String   @db.Text
  createdAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@map("group_comments")
}

model GroupMeeting {
  id          String    @id @default(cuid())
  groupId     String
  title       String
  description String?   @db.Text
  startTime   DateTime
  endTime     DateTime?
  location    String?
  isRecurring Boolean   @default(false)
  isCancelled Boolean   @default(false)
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  group      Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  attendance GroupAttendance[]

  @@index([groupId])
  @@index([groupId, startTime])
  @@map("group_meetings")
}

model GroupAttendance {
  id           String   @id @default(cuid())
  meetingId    String
  groupId      String
  membershipId String
  attended     Boolean  @default(false)
  notes        String?  @db.Text
  createdAt    DateTime @default(now())

  meeting    GroupMeeting    @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  group      Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  membership GroupMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@unique([meetingId, membershipId])
  @@index([meetingId])
  @@index([groupId])
  @@index([membershipId])
  @@map("group_attendance")
}

model GroupResource {
  id          String   @id @default(cuid())
  groupId     String
  title       String
  description String?  @db.Text
  type        String // "document", "video", "audio", "link", "curriculum"
  url         String?
  fileUrl     String?
  createdBy   String // userId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([groupId, type])
  @@map("group_resources")
}

model GroupPrayerRequest {
  id          String    @id @default(cuid())
  groupId     String
  requestedBy String // userId or "anonymous"
  title       String
  content     String    @db.Text
  isAnswered  Boolean   @default(false)
  answeredAt  DateTime?
  isPrivate   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([groupId, isAnswered])
  @@map("group_prayer_requests")
}

model ServicePlan {
  id         String        @id @default(cuid())
  orgId      String
  templateId String?       // Optional: created from this template
  name       String
  date       DateTime
  campus     String?
  status     ServiceStatus @default(draft)
  notes      String?       @db.Text
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  organization  Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  template      ServiceTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  items         ServiceItem[]
  assignments   ServiceAssignment[]
  notifications Notification[]

  @@index([orgId])
  @@index([orgId, date])
  @@index([templateId])
  @@map("service_plans")
}

model ServiceItem {
  id            String          @id @default(cuid())
  servicePlanId String
  songId        String? // Optional: linked to music library
  type          ServiceItemType
  title         String
  key           String? // Musical key (for songs)
  durationSec   Int             @default(0)
  position      Int // Order in the service
  attachments   Json            @default("[]") // Array of {fileId, name, url}
  notes         String?         @db.Text
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  servicePlan ServicePlan @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  song        Song?       @relation(fields: [songId], references: [id], onDelete: SetNull)

  @@index([servicePlanId])
  @@index([songId])
  @@map("service_items")
}

model ServiceAssignment {
  id            String           @id @default(cuid())
  servicePlanId String
  personId      String
  role          String // e.g., "Acoustic Guitar", "Camera 1", "Vocals"
  status        AssignmentStatus @default(pending)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  servicePlan   ServicePlan    @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  person        Person         @relation(fields: [personId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@unique([servicePlanId, personId, role])
  @@index([servicePlanId])
  @@index([personId])
  @@index([personId, status])
  @@map("service_assignments")
}

model File {
  id        String   @id @default(cuid())
  orgId     String
  path      String // Full MinIO path
  kind      String // "person_photo", "service_attachment", etc.
  ownerType String // "Person", "ServiceItem", etc.
  ownerId   String // ID of the owner entity
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([ownerType, ownerId])
  @@map("files")
}

model AuditLog {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  action    String // "created", "updated", "deleted"
  entity    String // "Person", "ServicePlan", etc.
  entityId  String
  diff      Json? // Changes made
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Service Templates - for quick service planning
model ServiceTemplate {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?  @db.Text
  template    Json // Array of template items: {type, title, durationSec, notes}
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  servicePlans ServicePlan[]

  @@index([orgId])
  @@index([orgId, isDefault])
  @@map("service_templates")
}

// Music Library - Songs and Arrangements
model Song {
  id            String   @id @default(cuid())
  orgId         String
  title         String
  artist        String?
  ccliNumber    String?
  bpm           Int?
  timeSignature String? // e.g., "4/4", "3/4"
  tags          Json     @default("[]") // Array of strings: ["worship", "fast", "contemporary"]
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  arrangements Arrangement[]
  serviceItems ServiceItem[]

  @@index([orgId])
  @@index([orgId, title])
  @@map("songs")
}

model Arrangement {
  id         String   @id @default(cuid())
  songId     String
  name       String // e.g., "Standard", "Acoustic", "Radio Version"
  key        String // e.g., "C", "D", "Eb"
  chordChart String?  @db.Text // URL or text content
  lyrics     String?  @db.Text
  audio      String? // URL to audio file
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  song Song @relation(fields: [songId], references: [id], onDelete: Cascade)

  @@index([songId])
  @@map("arrangements")
}

// Person Availability - for conflict detection
model PersonAvailability {
  id        String   @id @default(cuid())
  personId  String
  date      DateTime
  available Boolean  @default(true)
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, date])
  @@index([personId])
  @@index([date])
  @@map("person_availability")
}

// Notifications - automatic reminders
model Notification {
  id             String             @id @default(cuid())
  orgId          String
  type           NotificationType
  status         NotificationStatus @default(pending)
  servicePlanId  String?
  assignmentId   String?
  recipientEmail String
  recipientName  String?
  subject        String
  body           String             @db.Text
  scheduledFor   DateTime
  sentAt         DateTime?
  error          String?            @db.Text
  createdAt      DateTime           @default(now())

  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  servicePlan  ServicePlan?       @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  assignment   ServiceAssignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status, scheduledFor])
  @@index([servicePlanId])
  @@index([assignmentId])
  @@map("notifications")
}

// ==================== PEOPLE MODULE EXTENSIONS ====================

// Households for family management
model Household {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  phone       String?
  email       String?
  addressId   String?  // Primary household address
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members      Person[]

  @@index([orgId])
  @@map("households")
}

// Multiple phone numbers per person
model PersonPhone {
  id         String            @id @default(cuid())
  personId   String
  type       ContactMethodType
  number     String
  isPrimary  Boolean           @default(false)
  doNotCall  Boolean           @default(false)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@map("person_phones")
}

// Multiple email addresses per person
model PersonEmail {
  id         String   @id @default(cuid())
  personId   String
  email      String
  isPrimary  Boolean  @default(false)
  isWork     Boolean  @default(false)
  bounced    Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([email])
  @@map("person_emails")
}

// Physical addresses
model PersonAddress {
  id           String      @id @default(cuid())
  personId     String
  type         AddressType
  street       String
  street2      String?
  city         String
  state        String
  zip          String
  country      String      @default("US")
  isPrimary    Boolean     @default(false)
  latitude     Float?
  longitude    Float?
  isValidated  Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([zip])
  @@map("person_addresses")
}

// Emergency contacts
model EmergencyContact {
  id           String   @id @default(cuid())
  personId     String
  name         String
  relationship String
  phone        String
  email        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@map("emergency_contacts")
}

// Tag categories for organization
model TagCategory {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  color       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tags         Tag[]

  @@index([orgId])
  @@map("tag_categories")
}

// Individual tags
model Tag {
  id          String   @id @default(cuid())
  orgId       String
  categoryId  String?
  name        String
  color       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  category     TagCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  personTags   PersonTag[]

  @@unique([orgId, name])
  @@index([orgId])
  @@index([categoryId])
  @@map("tags")
}

// Many-to-many relationship between people and tags
model PersonTag {
  id         String   @id @default(cuid())
  personId   String
  tagId      String
  addedBy    String?  // User ID who added the tag
  createdAt  DateTime @default(now())

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([personId, tagId])
  @@index([personId])
  @@index([tagId])
  @@map("person_tags")
}

// Custom field definitions
model CustomFieldDefinition {
  id              String          @id @default(cuid())
  orgId           String
  name            String
  label           String
  type            CustomFieldType
  options         Json?           // For dropdown fields: {values: ["option1", "option2"]}
  defaultValue    String?
  isRequired      Boolean         @default(false)
  isVisible       Boolean         @default(true)
  visibleToRoles  Json?           // Array of role names
  groupName       String?         // For organizing fields into sections
  position        Int             @default(0)
  validationRules Json?           // {min, max, pattern, etc.}
  helpText        String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  values       CustomFieldValue[]

  @@unique([orgId, name])
  @@index([orgId])
  @@map("custom_field_definitions")
}

// Custom field values for people
model CustomFieldValue {
  id        String   @id @default(cuid())
  personId  String
  fieldId   String
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  person Person                 @relation(fields: [personId], references: [id], onDelete: Cascade)
  field  CustomFieldDefinition @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([personId, fieldId])
  @@index([personId])
  @@index([fieldId])
  @@map("custom_field_values")
}

// Saved lists (both static and smart)
model SavedList {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?
  type        ListType
  filters     Json?    // For smart lists: {status: "active", tags: ["volunteer"]}
  personIds   Json?    // For static lists: ["id1", "id2", ...]
  createdBy   String?  // User ID
  isShared    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("saved_lists")
}

// Notes attached to people
model PersonNote {
  id         String        @id @default(cuid())
  personId   String
  category   NoteCategory  @default(general)
  content    String        @db.Text
  authorId   String        // User ID
  isPrivate  Boolean       @default(false)
  pinned     Boolean       @default(false)
  attachments Json?        // Array of file URLs
  reminderAt DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([authorId])
  @@index([reminderAt])
  @@map("person_notes")
}

// Attendance tracking
model AttendanceRecord {
  id            String   @id @default(cuid())
  orgId         String
  personId      String
  servicePlanId String?  // For service attendance
  groupId       String?  // For group attendance
  date          DateTime
  present       Boolean  @default(true)
  notes         String?
  createdAt     DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, servicePlanId, date])
  @@index([orgId])
  @@index([personId])
  @@index([date])
  @@map("attendance_records")
}

// Public forms for data collection
model Form {
  id            String   @id @default(cuid())
  orgId         String
  name          String
  description   String?
  fields        Json     // Array of field definitions
  isPublic      Boolean  @default(true)
  requireAuth   Boolean  @default(false)
  allowAnonymous Boolean @default(false)
  confirmEmail  String?  @db.Text // Confirmation email template
  embedCode     String?  @db.Text
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organization Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  submissions  FormSubmission[]

  @@index([orgId])
  @@map("forms")
}

// Form submissions
model FormSubmission {
  id           String   @id @default(cuid())
  formId       String
  personId     String?  // Linked person if not anonymous
  data         Json     // Submitted form data
  ipAddress    String?
  userAgent    String?
  isReviewed   Boolean  @default(false)
  reviewedBy   String?  // User ID
  reviewedAt   DateTime?
  createdAt    DateTime @default(now())

  form   Form    @relation(fields: [formId], references: [id], onDelete: Cascade)
  person Person? @relation(fields: [personId], references: [id], onDelete: SetNull)

  @@index([formId])
  @@index([personId])
  @@index([createdAt])
  @@map("form_submissions")
}

// Email templates
model EmailTemplate {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  subject     String
  body        String   @db.Text
  variables   Json?    // Available merge fields
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization  Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  communications Communication[]

  @@index([orgId])
  @@map("email_templates")
}

// SMS templates
model SmsTemplate {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  message     String
  variables   Json?
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("sms_templates")
}

// Communication history (emails, SMS)
model Communication {
  id             String    @id @default(cuid())
  personId       String
  type           String    // email, sms
  templateId     String?
  subject        String?
  content        String    @db.Text
  status         String    // sent, failed, bounced, opened, clicked
  sentAt         DateTime?
  openedAt       DateTime?
  clickedAt      DateTime?
  error          String?
  externalId     String?   // ID from email/SMS provider
  createdAt      DateTime  @default(now())

  person   Person         @relation(fields: [personId], references: [id], onDelete: Cascade)
  template EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([personId])
  @@index([status])
  @@index([sentAt])
  @@map("communications")
}

// Workflows (automation)
model Workflow {
  id          String         @id @default(cuid())
  orgId       String
  name        String
  description String?
  trigger     Json           // {type: "tag_added", tagId: "xyz"}
  steps       Json           // Array of workflow steps
  status      WorkflowStatus @default(active)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  instances    WorkflowInstance[]

  @@index([orgId])
  @@index([status])
  @@map("workflows")
}

// Workflow instances (per person)
model WorkflowInstance {
  id             String   @id @default(cuid())
  workflowId     String
  personId       String
  currentStep    Int      @default(0)
  status         String   // running, completed, failed, paused
  startedAt      DateTime @default(now())
  completedAt    DateTime?
  error          String?
  stepHistory    Json?    // Array of completed steps
  updatedAt      DateTime @updatedAt

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  person   Person   @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([personId])
  @@index([status])
  @@map("workflow_instances")
}

// Reports (saved queries and analytics)
model Report {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?
  type        String   // demographic, growth, engagement, custom
  config      Json     // Report configuration
  schedule    String?  // Cron expression for scheduled reports
  recipients  Json?    // Array of email addresses
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("reports")
}
