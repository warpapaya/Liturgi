// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  leader
  member
  viewer
}

enum Plan {
  trial
  basic
  pro
}

enum PersonStatus {
  active
  inactive
}

enum ServiceItemType {
  song
  element
  note
}

enum AssignmentStatus {
  pending
  accepted
  declined
}

enum GroupMemberRole {
  leader
  member
}

enum NotificationType {
  assignment_created
  assignment_reminder
  service_updated
  conflict_detected
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum UserAccountStatus {
  active
  deactivated
  deleted
}

enum TwoFactorMethod {
  totp
  sms
  email
}

model Organization {
  id              String   @id @default(cuid())
  name            String
  subdomain       String   @unique
  customDomain    String?  // For white-label
  plan            Plan     @default(trial)
  planLimits      Json     // {people: 100, groups: 10, servicePlans: 10}
  trialEndAt      DateTime?
  logoUrl         String?
  timezone        String   @default("America/New_York")
  dateFormat      String   @default("MM/dd/yyyy")
  timeFormat      String   @default("12h")
  locale          String   @default("en-US")
  campus          String?  // Default campus
  campuses        Json     @default("[]") // Array of campus objects
  customFields    Json     @default("{}") // Custom org fields
  settings        Json     @default("{}") // Additional settings
  brandingColors  Json?    // Custom colors for white-label
  emailFromName   String?  // Custom email sender name
  emailFromAddress String? // Custom email sender address
  smtpSettings    Json?    // SMTP configuration
  isActive        Boolean  @default(true)
  suspendedAt     DateTime?
  deletedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users              User[]
  sessions           Session[]
  invites            Invite[]
  people             Person[]
  groups             Group[]
  servicePlans       ServicePlan[]
  serviceTemplates   ServiceTemplate[]
  songs              Song[]
  files              File[]
  auditLogs          AuditLog[]
  notifications      Notification[]
  emailTemplates     EmailTemplate[]
  customRoles        CustomRole[]
  apiKeys            ApiKey[]
  webhooks           Webhook[]
  subscription       Subscription?
  featureFlags       FeatureFlag[]
  integrations       Integration[]

  @@index([subdomain])
  @@index([customDomain])
  @@index([isActive])
  @@map("organizations")
}

model User {
  id                String            @id @default(cuid())
  orgId             String
  email             String
  passwordHash      String
  role              Role              @default(member)
  firstName         String?
  lastName          String?
  photoUrl          String?
  phoneNumber       String?
  accountStatus     UserAccountStatus @default(active)
  emailVerified     Boolean           @default(false)
  emailVerifiedAt   DateTime?
  twoFactorEnabled  Boolean           @default(false)
  twoFactorMethod   TwoFactorMethod?
  twoFactorSecret   String?           // TOTP secret
  twoFactorBackupCodes Json?          // Array of backup codes
  require2FA        Boolean           @default(false) // Role-based enforcement
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastLoginAt       DateTime?
  deletedAt         DateTime?
  dataRetentionUntil DateTime?        // For GDPR compliance

  organization       Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sessions           Session[]
  auditLogs          AuditLog[]
  invitesSent        Invite[]            @relation("InvitesSent")
  passwordResets     PasswordReset[]
  emailVerifications EmailVerification[]
  loginHistory       LoginHistory[]

  @@unique([orgId, email])
  @@index([orgId])
  @@index([email])
  @@index([accountStatus])
  @@map("users")
}

model Invite {
  id         String    @id @default(cuid())
  orgId      String
  email      String
  role       Role      @default(member)
  invitedBy  String
  code       String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  inviter      User         @relation("InvitesSent", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([email])
  @@index([code])
  @@map("invites")
}

model Session {
  id            String   @id @default(cuid())
  orgId         String
  userId        String
  expiresAt     DateTime
  ipAddress     String?
  ipFingerprint String?
  userAgent     String?
  deviceName    String?  // e.g., "Chrome on MacOS"
  lastAccessedAt DateTime @default(now())
  createdAt     DateTime @default(now())

  organization  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model PasswordReset {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  ipAddress  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

model EmailVerification {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

model LoginHistory {
  id         String   @id @default(cuid())
  userId     String
  ipAddress  String?
  userAgent  String?
  deviceName String?
  success    Boolean  @default(true)
  failReason String?  // "invalid_credentials", "2fa_failed", "account_locked", etc.
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([ipAddress])
  @@map("login_history")
}

model Person {
  id         String       @id @default(cuid())
  orgId      String
  firstName  String
  lastName   String
  email      String?
  phone      String?
  photoUrl   String?
  tags       Json         @default("[]") // Array of strings
  notes      String?      @db.Text
  status     PersonStatus @default(active)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  organization       Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  groupMemberships   GroupMembership[]
  serviceAssignments ServiceAssignment[]
  availability       PersonAvailability[]

  @@index([orgId])
  @@index([orgId, status])
  @@index([orgId, email])
  @@map("people")
}

model Group {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?  @db.Text
  cadence     String?  // Free text: "Weekly on Wednesdays", "Bi-weekly", etc.
  location    String?
  isOpen      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members      GroupMembership[]
  comments     GroupComment[]

  @@index([orgId])
  @@map("groups")
}

model GroupMembership {
  id        String          @id @default(cuid())
  groupId   String
  personId  String
  role      GroupMemberRole @default(member)
  createdAt DateTime        @default(now())

  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([groupId, personId])
  @@index([groupId])
  @@index([personId])
  @@map("group_memberships")
}

model GroupComment {
  id        String   @id @default(cuid())
  groupId   String
  userId    String   // Not FK to avoid cascade issues if user deleted
  content   String   @db.Text
  createdAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@map("group_comments")
}

model ServicePlan {
  id         String   @id @default(cuid())
  orgId      String
  templateId String?  // Optional: created from this template
  name       String
  date       DateTime
  campus     String?
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  organization Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  template     ServiceTemplate?     @relation(fields: [templateId], references: [id], onDelete: SetNull)
  items        ServiceItem[]
  assignments  ServiceAssignment[]
  notifications Notification[]

  @@index([orgId])
  @@index([orgId, date])
  @@index([templateId])
  @@map("service_plans")
}

model ServiceItem {
  id            String          @id @default(cuid())
  servicePlanId String
  songId        String?         // Optional: linked to music library
  type          ServiceItemType
  title         String
  key           String?         // Musical key (for songs)
  durationSec   Int             @default(0)
  position      Int             // Order in the service
  attachments   Json            @default("[]") // Array of {fileId, name, url}
  notes         String?         @db.Text
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  servicePlan ServicePlan @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  song        Song?       @relation(fields: [songId], references: [id], onDelete: SetNull)

  @@index([servicePlanId])
  @@index([songId])
  @@map("service_items")
}

model ServiceAssignment {
  id            String           @id @default(cuid())
  servicePlanId String
  personId      String
  role          String           // e.g., "Acoustic Guitar", "Camera 1", "Vocals"
  status        AssignmentStatus @default(pending)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  servicePlan   ServicePlan    @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  person        Person         @relation(fields: [personId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@unique([servicePlanId, personId, role])
  @@index([servicePlanId])
  @@index([personId])
  @@index([personId, status])
  @@map("service_assignments")
}

model File {
  id        String   @id @default(cuid())
  orgId     String
  path      String   // Full MinIO path
  kind      String   // "person_photo", "service_attachment", etc.
  ownerType String   // "Person", "ServiceItem", etc.
  ownerId   String   // ID of the owner entity
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([ownerType, ownerId])
  @@map("files")
}

model AuditLog {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  action    String   // "created", "updated", "deleted"
  entity    String   // "Person", "ServicePlan", etc.
  entityId  String
  diff      Json?    // Changes made
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([orgId, entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Service Templates - for quick service planning
model ServiceTemplate {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?  @db.Text
  template    Json     // Array of template items: {type, title, durationSec, notes}
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization  Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  servicePlans  ServicePlan[]

  @@index([orgId])
  @@index([orgId, isDefault])
  @@map("service_templates")
}

// Music Library - Songs and Arrangements
model Song {
  id          String   @id @default(cuid())
  orgId       String
  title       String
  artist      String?
  ccliNumber  String?
  bpm         Int?
  timeSignature String? // e.g., "4/4", "3/4"
  tags        Json     @default("[]") // Array of strings: ["worship", "fast", "contemporary"]
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization  Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  arrangements  Arrangement[]
  serviceItems  ServiceItem[]

  @@index([orgId])
  @@index([orgId, title])
  @@map("songs")
}

model Arrangement {
  id          String   @id @default(cuid())
  songId      String
  name        String   // e.g., "Standard", "Acoustic", "Radio Version"
  key         String   // e.g., "C", "D", "Eb"
  chordChart  String?  @db.Text // URL or text content
  lyrics      String?  @db.Text
  audio       String?  // URL to audio file
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  song Song @relation(fields: [songId], references: [id], onDelete: Cascade)

  @@index([songId])
  @@map("arrangements")
}

// Person Availability - for conflict detection
model PersonAvailability {
  id        String   @id @default(cuid())
  personId  String
  date      DateTime
  available Boolean  @default(true)
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, date])
  @@index([personId])
  @@index([date])
  @@map("person_availability")
}

// Notifications - automatic reminders
model Notification {
  id           String             @id @default(cuid())
  orgId        String
  type         NotificationType
  status       NotificationStatus @default(pending)
  servicePlanId String?
  assignmentId String?
  recipientEmail String
  recipientName String?
  subject      String
  body         String            @db.Text
  scheduledFor DateTime
  sentAt       DateTime?
  error        String?           @db.Text
  createdAt    DateTime          @default(now())

  organization Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  servicePlan  ServicePlan?       @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  assignment   ServiceAssignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status, scheduledFor])
  @@index([servicePlanId])
  @@index([assignmentId])
  @@map("notifications")
}

// Email Templates - customizable email templates
model EmailTemplate {
  id          String   @id @default(cuid())
  orgId       String
  name        String   // e.g., "welcome", "password_reset", "assignment_notification"
  subject     String
  htmlBody    String   @db.Text
  textBody    String?  @db.Text
  variables   Json     @default("[]") // Array of variable names: ["userName", "resetLink"]
  isSystem    Boolean  @default(false) // System templates can't be deleted
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
  @@map("email_templates")
}

// Roles - custom role management
model CustomRole {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  description String?  @db.Text
  permissions Json     // Array of permission strings
  priority    Int      @default(0) // Higher priority = more permissions
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
  @@map("custom_roles")
}

// API Keys - for API access
model ApiKey {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  keyHash     String   @unique
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  rateLimit   Int      @default(1000) // Requests per hour
  permissions Json     @default("[]") // Scoped permissions
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([keyHash])
  @@map("api_keys")
}

// Webhooks - webhook configuration
model Webhook {
  id          String   @id @default(cuid())
  orgId       String
  url         String
  events      Json     @default("[]") // Array of event names
  secret      String   // For signature verification
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([orgId])
  @@map("webhooks")
}

// Webhook Deliveries - webhook delivery logs
model WebhookDelivery {
  id          String   @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  statusCode  Int?
  response    String?  @db.Text
  error       String?  @db.Text
  attempts    Int      @default(0)
  nextRetryAt DateTime?
  succeededAt DateTime?
  failedAt    DateTime?
  createdAt   DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// Billing - subscription and payment tracking
model Subscription {
  id                String   @id @default(cuid())
  orgId             String   @unique
  stripeCustomerId  String?  @unique
  stripeSubscriptionId String? @unique
  stripePriceId     String?
  status            String   // active, past_due, canceled, trialing
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean  @default(false)
  canceledAt        DateTime?
  trialEnd          DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  usageRecords UsageRecord[]

  @@index([orgId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

// Invoices - billing invoices
model Invoice {
  id             String   @id @default(cuid())
  subscriptionId String
  stripeInvoiceId String? @unique
  amountDue      Int      // In cents
  amountPaid     Int      // In cents
  currency       String   @default("usd")
  status         String   // draft, open, paid, void, uncollectible
  hostedUrl      String?
  pdfUrl         String?
  dueDate        DateTime?
  paidAt         DateTime?
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@map("invoices")
}

// Usage Records - for usage-based billing
model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String
  metric         String   // e.g., "people", "services", "sms_sent"
  quantity       Int
  timestamp      DateTime
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([metric, timestamp])
  @@map("usage_records")
}

// Feature Flags - feature management per organization
model FeatureFlag {
  id          String   @id @default(cuid())
  orgId       String
  name        String   // e.g., "advanced_scheduling", "ai_suggestions"
  enabled     Boolean  @default(false)
  config      Json?    // Additional configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
  @@map("feature_flags")
}

// Saved Searches - user saved searches
model SavedSearch {
  id          String   @id @default(cuid())
  userId      String
  name        String
  entity      String   // "people", "services", "groups"
  filters     Json     // Search filter configuration
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("saved_searches")
}

// Integrations - third-party integration status
model Integration {
  id          String   @id @default(cuid())
  orgId       String
  name        String   // "stripe", "mailchimp", "zapier", "google_workspace"
  status      String   // "active", "error", "disabled"
  config      Json     // Integration-specific configuration (encrypted)
  credentials Json?    // Encrypted credentials
  lastSyncAt  DateTime?
  error       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, name])
  @@index([orgId])
  @@map("integrations")
}
